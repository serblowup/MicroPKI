# MicroPKI

Минимальная реализация инфраструктуры открытых ключей (PKI) в рамках курса криптографии.

## Возможности

- Создание самоподписанного корневого УЦ (RSA 4096 или ECC P-384)
- Безопасное хранение ключей с шифрованием
- Генерация X.509 сертификатов с правильными расширениями
- Документирование политики сертификации

## Требования

- Go 1.21 или выше (разработка на go 1.25.7 X:nodwarf5 linux/amd64)
- Make (для сборки)
- OpenSSL (для проверки сертификатов)

## Зависимости

- github.com/spf13/cobra (CLI фреймворк)
- Стандартные криптографические пакеты Go

## Установка

```bash
# Клонирование репозитория
git clone https://github.com/serblowup/MicroPKI.git
cd MicroPKI

# Установка зависимостей
go mod tidy

# Очистка
make clean

# Сборка проекта
make build

# Запуск всех тестов
make test
```

После сборки бинарный файл будет доступен в ./bin/micropki.

### Использование

1. Создание корневого УЦ (RSA 4096)

```bash
# Создаем файл с парольной фразой для шифрования ключа
echo "mysecurepassphrase" > pass.txt
# Защищаем файл с паролем
chmod 600 pass.txt

# Создаем корневой УЦ
./bin/micropki ca init \
    --subject "/CN=Test Root CA" \
    --passphrase-file ./pass.txt \
    --out-dir ./myca \
    --log-file ./ca-init.log
```

2. Проверка результата

```bash
# Проверяем структуру директорий
ls -la myca/
# Ключ с правами 0600
ls -la myca/private/  # ключ с правами 0600
# Сертификат с правами 0644
ls -la myca/certs/

# Просмотр лога операций
cat ca-init.log

# Просмотр содержимого сертификата
openssl x509 -in myca/certs/ca.cert.pem -text -noout

# Проверка самоподписанного сертификата
openssl verify -CAfile myca/certs/ca.cert.pem myca/certs/ca.cert.pem

# Или же
make verify
```

3. Создание УЦ на ECC P-384
```bash
./bin/micropki ca init \
    --subject "CN=ECC Root CA,O=Test" \
    --key-type ecc \
    --key-size 384 \
    --passphrase-file ./pass.txt \
    --out-dir ./myca-ecc \
    --log-file ./ecc-init.log
```

### Команда `ca init` - инициализация корневого УЦ

Параметр : Описание : Значение по умолчанию

`--subject` : Distinguished Name (обязательно) : -
`--key-type` : Тип ключа: `rsa` или `ecc` : `rsa`
`--key-size` : Размер ключа в битах  : `4096` (RSA), `384` (ECC)
`--passphrase-file` : Файл с парольной фразой (обязательно) : -
`--out-dir` : Выходная директория : `./pki`
`--validity-days` : Срок действия в днях : `3650` (10 лет)
`--log-file` : Файл для логов (опционально) : stderr
`--force` : Принудительная перезапись : `false`

### Структура выходной директории

```
./myca/
├── private/
│   └── ca.key.pem      # зашифрованный закрытый ключ (права 0600)
├── certs/
│   └── ca.cert.pem     # самоподписанный сертификат (права 0644)
└── policy.txt          # документ политики сертификации
```

### Пример `policy.txt`:
```
[CERTIFICATE POLICY DOCUMENT]
CA Name: /CN=Test Root CA
Certificate Serial Number: 6a148804376dd5da12b05519d5fad168dd563f
Validity Period: 
  Not Before: 2026-02-25T20:57:52Z
  Not After:  2036-02-23T20:57:52Z
Key Algorithm: rsa-4096
Purpose: Root CA for MicroPKI demonstration
Policy Version: 1.0
Creation Date: 2026-02-25T23:57:52+03:00
Generated by: MicroPKI
```

#### Логирование

Все операции детально логируются:
- Временная метка в формате ISO 8601
- Уровни: INFO, WARN, ERROR
- Конфиденциальные данные (пароли) автоматически скрываются
Пример логов:
```text
2026-02-25T10:15:30.123Z [INFO] Начало инициализации корневого УЦ
2026-02-25T10:15:30.124Z [INFO] Параметры: Subject=/CN=Test Root CA, KeyType=rsa...
2026-02-25T10:15:31.456Z [INFO] Ключи успешно сгенерированы
2026-02-25T10:15:31.789Z [INFO] Сертификат сохранен: ./myca/certs/ca.cert.pem
```

#### Тестирование

Тесты проверяют:
- Генерацию RSA и ECC ключей
- Создание и валидацию сертификатов
- Соответствие ключа и сертификата
- Негативные сценарии (неверные параметры)
- Загрузку зашифрованных ключей
- Парсинг DN в разных форматах

#### Безопасность

1. **Закрытый ключ**: зашифрован AES-256, права доступа 0600
2. **Парольная фраза**: никогда не попадает в логи (автоматически скрывается)
3. **Временные данные**: очищаются из памяти после использования
4. **OpenSSL совместимость**: ключи и сертификаты работают с OpenSSL

##### Структура проекта
```
MicroPKI/
├── cmd
│   └── micropki
│       └── main.go
├── .gitignore
├── go.mod
├── go.sum
├── internal
│   ├── ca
│   │   └── ca.go
│   ├── certs
│   │   └── certificate.go
│   ├── cryptoutil
│   │   └── crypto.go
│   └── logger
│       └── logger.go
├── Makefile
├── README.md
├── scripts
│   └── test.sh
└── tests
    ├── ca_test.go
    └── crypto_test.go
```
